<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - HSIT</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="auth.css">
</head>
<body class="auth-page">
    <div id="statusMessage" class="status-message"></div>
    <div class="auth-container">
        <img src="logo.png" alt="HSIT Logo" class="logo">
        <h1>Create Account</h1>
        
        <!-- Step 1: Initial Signup Form -->
        <form id="signupForm">
             <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" name="phone" placeholder="+15873304312" pattern="^\+[1-9]\d{1,14}$" required>
                <small>Required for SMS verification (format: +CountryCodeNumber e.g., +15873304312)</small>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required>
            </div>
             <div class="form-group">
                <label for="confirm-password">Confirm Password</label>
                <input type="password" id="confirm-password" name="confirm-password" required>
            </div>
            <div class="form-group">
                <label for="invitation-code">Invitation Code (Optional)</label>
                <input type="text" id="invitation-code" name="invitation-code">
            </div>
            <div class="form-group privacy-policy">
                <input type="checkbox" id="privacy-policy" name="privacy-policy" required>
                <label for="privacy-policy">I agree to the <a href="#" target="_blank">Privacy Policy</a></label> 
            </div>
            <button type="submit" class="btn btn-primary">Sign Up</button>
        </form>
        
        <!-- Step 2: Verification Form (hidden initially) -->
        <form id="verificationForm" style="display: none;">
            <div class="form-group">
                <label for="verification-code">Verification Code</label>
                <input type="text" id="verification-code" name="verification-code" required>
                <small>Enter the 6-digit code sent to your phone</small>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Verify</button>
                <button type="button" id="resend-code" class="btn btn-secondary">Resend Code</button>
            </div>
        </form>
        
        <p class="auth-switch">
            Already have an account? <a href="index.html">Log In</a>
        </p>
    </div>
    
    <script src="js/config.js"></script> 
    <script src="js/twilio-verification.js"></script>
    <script src="js/auth.js"></script>
</body>
</html>


/**
 * direct-sms-verification.js
 * 
 * Alternative implementation using direct SMS instead of Twilio Verify API.
 * This can be used if you prefer to handle verification codes yourself.
 */

const express = require('express');
const router = express.Router();
const twilio = require('twilio');
const crypto = require('crypto');
const { body, validationResult } = require('express-validator');

// Load environment variables
require('dotenv').config();

// Initialize Twilio client
const twilioClient = twilio(
    process.env.TWILIO_ACCOUNT_SID,  // ACa349c314fae309a21427c73a204d7afc
    process.env.TWILIO_AUTH_TOKEN    // 29ebf5ec303ed1208d74592b114d2a31
);

// In-memory storage for verification codes (replace with database in production)
const verificationCodes = new Map();

/**
 * Generate a random 6-digit verification code
 * @returns {string} - 6-digit code
 */
function generateVerificationCode() {
    return Math.floor(100000 + Math.random() * 900000).toString();
}

/**
 * Start phone verification process
 * POST /api/auth/verify/start
 */
router.post('/verify/start', [
    body('phone').matches(/^\+[1-9]\d{1,14}$/).withMessage('Phone number must be in E.164 format (e.g., +15873304312)')
], async (req, res) => {
    // Validate request
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ success: false, message: errors.array()[0].msg });
    }

    const { phone } = req.body;

    try {
        // Generate verification code
        const verificationCode = generateVerificationCode();
        
        // Store code with timestamp (expires in 5 minutes)
        verificationCodes.set(phone, {
            code: verificationCode,
            timestamp: Date.now(),
            attempts: 0
        });
        
        // Send SMS with verification code
        await twilioClient.messages.create({
            body: `Your verification code is: ${verificationCode}`,
            from: process.env.TWILIO_PHONE_NUMBER,  // +15873304312
            to: phone
        });

        return res.status(200).json({
            success: true,
            message: 'Verification code sent'
        });
    } catch (error) {
        console.error('SMS sending error:', error);
        return res.status(500).json({
            success: false,
            message: 'Failed to send verification code',
            error: error.message
        });
    }
});

/**
 * Check verification code
 * POST /api/auth/verify/check
 */
router.post('/verify/check', [
    body('phone').isMobilePhone().withMessage('Valid phone number is required'),
    body('code').isLength({ min: 6, max: 6 }).withMessage('Valid 6-digit code is required')
], async (req, res) => {
    // Validate request
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ success: false, message: errors.array()[0].msg });
    }

    const { phone, code } = req.body;

    try {
        // Get stored verification data
        const verification = verificationCodes.get(phone);
        
        if (!verification) {
            return res.status(400).json({
                success: false,
                message: 'No verification code found for this phone number',
                verified: false
            });
        }
        
        // Check if code is expired (5 minutes)
        const expirationTime = verification.timestamp + (5 * 60 * 1000);
        if (Date.now() > expirationTime) {
            verificationCodes.delete(phone);
            return res.status(400).json({
                success: false,
                message: 'Verification code has expired',
                verified: false
            });
        }
        
        // Check max attempts (limit to 3)
        verification.attempts += 1;
        if (verification.attempts > 3) {
            verificationCodes.delete(phone);
            return res.status(400).json({
                success: false,
                message: 'Too many failed attempts',
                verified: false
            });
        }
        
        // Check if code matches
        if (verification.code === code) {
            // Code verified - clear from storage
            verificationCodes.delete(phone);
            
            return res.status(200).json({
                success: true,
                message: 'Phone number verified successfully',
                verified: true
            });
        } else {
            return res.status(400).json({
                success: false,
                message: 'Invalid verification code',
                verified: false,
                attemptsRemaining: 3 - verification.attempts
            });
        }
    } catch (error) {
        console.error('Verification check error:', error);
        return res.status(500).json({
            success: false,
            message: 'Failed to verify code',
            error: error.message
        });
    }
});

/**
 * Resend verification code
 * POST /api/auth/verify/resend
 */
router.post('/verify/resend', [
    body('phone').isMobilePhone().withMessage('Valid phone number is required')
], async (req, res) => {
    // Validate request
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ success: false, message: errors.array()[0].msg });
    }

    const { phone } = req.body;

    try {
        // Check for existing verification
        const existingVerification = verificationCodes.get(phone);
        
        // Implement cooldown (1 minute between resends)
        if (existingVerification && (Date.now() - existingVerification.timestamp) < 60000) {
            const timeRemaining = Math.ceil((60000 - (Date.now() - existingVerification.timestamp)) / 1000);
            return res.status(429).json({
                success: false,
                message: `Please wait ${timeRemaining} seconds before requesting a new code`,
            });
        }
        
        // Generate new verification code
        const verificationCode = generateVerificationCode();
        
        // Store code with timestamp
        verificationCodes.set(phone, {
            code: verificationCode,
            timestamp: Date.now(),
            attempts: 0
        });
        
        // Send SMS with verification code
        await twilioClient.messages.create({
            body: `Your verification code is: ${verificationCode}`,
            from: process.env.TWILIO_PHONE_NUMBER,  // +15873304312
            to: phone
        });

        return res.status(200).json({
            success: true,
            message: 'Verification code resent'
        });
    } catch (error) {
        console.error('Verification resend error:', error);
        return res.status(500).json({
            success: false,
            message: 'Failed to resend verification code',
            error: error.message
        });
    }
});

module.exports = router;
